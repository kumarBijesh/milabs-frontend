generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  password      String?
  role          String    @default("patient") // super_admin, admin, lab_admin, patient
  phone         String?
  address       String?
  pincode       String?  // Added
  walletBalance Float     @default(0)
  avatar        String?
  isVerified    Boolean   @default(false)
  encryptedData String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  accounts      Account[]
  sessions      Session[]
  orders        Order[]
  verificationToken String?
  otp           String?   // For Admin Login
  otpExpires    DateTime?
  
  // RBAC for Lab Admins
  labId         String?   @db.ObjectId
  lab           Lab?      @relation(fields: [labId], references: [id])
}

model Account {
  id                 String  @id @default(auto()) @map("_id") @db.ObjectId
  userId             String  @db.ObjectId
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionToken String   @unique
  userId       String   @db.ObjectId
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Lab {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  slug        String?  @unique
  description String?
  address     String?
  city        String?
  state       String?  // Added
  pincode     String?  // Added
  phone       String?  // Added
  email       String?  // Added
  rating      Float    @default(0)
  image       String?
  isVerified  Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tests       Test[]
  orders      Order[]
  packages    Package[] // Added reverse relation if needed, though seed links package to labId
  users       User[]    // Admins/Staff associated with this lab
}

model Test {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  slug        String?  @unique
  description String?
  price       Float
  originalPrice Float? // Added
  discount    Float?   // Added
  duration    String?
  preparation String?
  category    String?  // Health Checkup, Blood Test, etc.
  tat         String?  // Turnaround Time
  labId       String   @db.ObjectId
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  lab         Lab      @relation(fields: [labId], references: [id])
  orderItems  OrderItem[]
  packageTests PackageTest[]
}

model Package {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  slug        String?  @unique
  description String?
  price       Float
  originalPrice Float? // Added
  discount    Float?   // Added
  image       String?  // Added
  labId       String?  @db.ObjectId
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  lab         Lab?     @relation(fields: [labId], references: [id])
  orderItems  OrderItem[]
  packageTests PackageTest[]
}

model PackageTest {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  packageId String   @db.ObjectId
  testId    String   @db.ObjectId
  
  package   Package  @relation(fields: [packageId], references: [id])
  test      Test     @relation(fields: [testId], references: [id])

  @@unique([packageId, testId])
}

model Order {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  userId        String?   @db.ObjectId
  labId         String?   @db.ObjectId
  totalAmount   Float
  status        String    @default("pending") // pending, confirmed, completed, cancelled
  paymentStatus String    @default("pending") // pending, paid, failed
  paymentId     String?
  bookingDate   DateTime
  slotTime      String?
  reportUrl     String?
  paymentMethod String?   // Added
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // QR and Notifications
  qrCode         String?   // Data for QR code
  qrExpiresAt    DateTime? // 30 days from creation
  qrRedeemed     Boolean   @default(false)
  qrRedeemedAt   DateTime?
  lastReminderSent Int     @default(0) // 0, 20, 25, 28 to track which days reminders were sent

  // Relations
  user          User?     @relation(fields: [userId], references: [id])
  lab           Lab?      @relation(fields: [labId], references: [id])
  items         OrderItem[]
}

model OrderItem {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  orderId   String   @db.ObjectId
  testId    String?  @db.ObjectId
  packageId String?  @db.ObjectId
  quantity  Int      @default(1)
  price     Float

  // Relations
  order     Order    @relation(fields: [orderId], references: [id])
  test      Test?    @relation(fields: [testId], references: [id])
  package   Package? @relation(fields: [packageId], references: [id])
}

model ContactInquiry {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  email     String
  subject   String?
  message   String
  status    String   @default("new") // new, read, replied
  createdAt DateTime @default(now())
}
